<!DOCTYPE html>
<html
        xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
        layout:decorator="../templates/layout">
<head>
    <title>性能测试</title>
    <script>

        var API_URL = '/test/start';
        $(function () {
        });

        function queryClick() {

        $('#message').html('');

            $.ajax({
                    url: API_URL,
                    type: 'post',
                    contentType: 'application/json',
                    data: JSON.stringify($('#queryFrom').find('input,select,textarea').mineSerializeObject()),
                    success: function () {
                        showAlert('Performance start successful!', 'success');
                    },
                    error: function () {
                        showAlert('Performance tet error!', 'danger');
                    }
                });
        }

        function showAlert(title, type) {
            $('.alert').attr('class', 'alert alert-' + type || 'success')
                .html('<i class="glyphicon glyphicon-check"></i> ' + title).show();
            setTimeout(function () {
                $('.alert').hide();
            }, 3000);
        }
        var websocket = null;

        //判断当前浏览器是否支持WebSocket
        if('WebSocket' in window){
            websocket = new WebSocket("ws://0.0.0.0:8888/websocket");
        }
        else{
            showAlert('Not support websocket', 'danger')
        }

        //连接发生错误的回调方法
        websocket.onerror = function(){
            setMessageInnerHTML("error");
        };

        //连接成功建立的回调方法
        websocket.onopen = function(event){
            setMessageInnerHTML("open");
        }

        //接收到消息的回调方法
        websocket.onmessage = function(event){
            setMessageInnerHTML(event.data);
        }

        //连接关闭的回调方法
        websocket.onclose = function(){
            setMessageInnerHTML("close");
        }

        //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
        window.onbeforeunload = function(){
            websocket.close();
        }

        //将消息显示在网页上
        function setMessageInnerHTML(innerHTML){
            document.getElementById('message').innerHTML += innerHTML + '<br/>';
        }

        //关闭连接
        function closeWebSocket(){
            websocket.close();
        }

        //发送消息
        function send(){
            var message = document.getElementById('text').value;
            websocket.send(message);
        }

    </script>
</head>
<body>
<div layout:fragment="layout-content-title">性能测试</div>
<div layout:fragment="layout-content-body">

    <div class="panel panel-primary layout-panel">
        <div class="panel-heading">启动条件</div>
        <div class="panel-body">
            <form id="queryFrom" class="form-inline">
                <fieldset>

                    <div class='input-group'>
                        <span>
                        <input type="text" class="form-control input-sm" name="url"
                               value="http://localhost:8088/ws/openapi/users/test"
                               placeholder="地址：http:/localhost:8080/ws/openapi/users"/>&nbsp;地址
                        </span>
                        <br/><br/>
                        <span>
                        <input type="text" class="form-control input-sm" name="taskCount"
                               value="20"
                               placeholder="任务数"/>&nbsp;执行次数
                            </span>
                        <br/><br/>
                        <span>
                        <input type="text" class="form-control input-sm" name="threadCount"
                               value="10"
                               placeholder="线程数"/>&nbsp;并发数
                        </span>
                        <br/><br/>
                    </div>
                    <div>
                        <select name="method" class="form-control">
                            <option value="POST">POST</option>
                            <option value="GET">GET</option>
                        </select>
                    </div>
                    <br/>
                    请求参数
                    <br/>
                    <textarea name="params" placeholder="params" class="form-control" rows="3">
                        {
                                 "userAccount":"otms@com.cn",
                                  "companyApiAccount":"j4U4DQzU",
                                 "companyApiPassword":"******"
                        }
                    </textarea>
                    &nbsp;&nbsp;&nbsp;&nbsp;
                    <input type="button" class="btn btn-primary btn-sm layout-btn-center" onclick="queryClick();"
                           value="启动"/>
                </fieldset>
            </form>
        </div>
    </div>

    <div class="panel panel-info layout-panel">
        <div class="panel-body pre-scrollable" id="message">
        </div>
    </div>
</div>

</body>
</html>